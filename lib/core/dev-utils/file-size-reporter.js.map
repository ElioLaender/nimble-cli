{"version":3,"file":"file-size-reporter.js","sourceRoot":"","sources":["../../../src/core/dev-utils/file-size-reporter.ts"],"names":[],"mappings":"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","sourcesContent":["import fs from 'fs';\r\nimport path from 'path';\r\nimport chalk from 'chalk';\r\nimport filesize from 'filesize';\r\nimport recursive from 'recursive-readdir';\r\nimport stripAnsi from 'strip-ansi';\r\nimport { sync } from 'gzip-size';\r\n\r\nfunction canReadAsset(asset) {\r\n    return (\r\n        /\\.(js|css)$/.test(asset) &&\r\n        !/service-worker\\.js/.test(asset) &&\r\n        !/precache-manifest\\.[0-9a-f]+\\.js/.test(asset)\r\n    );\r\n}\r\n\r\n// Prints a detailed summary of build files.\r\nfunction printFileSizesAfterBuild(\r\n    webpackStats,\r\n    previousSizeMap,\r\n    buildFolder,\r\n    maxBundleGzipSize,\r\n    maxChunkGzipSize\r\n) {\r\n    var root = previousSizeMap.root;\r\n    var sizes = previousSizeMap.sizes;\r\n    var assets = (webpackStats.stats || [webpackStats])\r\n        .map(stats =>\r\n            stats\r\n                .toJson({ all: false, assets: true })\r\n                .assets.filter(asset => canReadAsset(asset.name))\r\n                .map(asset => {\r\n                    var fileContents = fs.readFileSync(path.join(root, asset.name));\r\n                    var size = sync(fileContents);\r\n                    var previousSize = sizes[removeFileNameHash(root, asset.name)];\r\n                    var difference = getDifferenceLabel(size, previousSize);\r\n                    return {\r\n                        folder: path.join(\r\n                            path.basename(buildFolder),\r\n                            path.dirname(asset.name)\r\n                        ),\r\n                        name: path.basename(asset.name),\r\n                        size: size,\r\n                        sizeLabel:\r\n                            filesize(size) + (difference ? ' (' + difference + ')' : ''),\r\n                    };\r\n                })\r\n        )\r\n        .reduce((single, all) => all.concat(single), []);\r\n    assets.sort((a, b) => b.size - a.size);\r\n    var longestSizeLabelLength = Math.max.apply(\r\n        null,\r\n        assets.map(a => stripAnsi(a.sizeLabel).length)\r\n    );\r\n    var suggestBundleSplitting = false;\r\n    assets.forEach(asset => {\r\n        var sizeLabel = asset.sizeLabel;\r\n        var sizeLength = stripAnsi(sizeLabel).length;\r\n        if (sizeLength < longestSizeLabelLength) {\r\n            var rightPadding = ' '.repeat(longestSizeLabelLength - sizeLength);\r\n            sizeLabel += rightPadding;\r\n        }\r\n        var isMainBundle = asset.name.indexOf('main.') === 0;\r\n        var maxRecommendedSize = isMainBundle\r\n            ? maxBundleGzipSize\r\n            : maxChunkGzipSize;\r\n        var isLarge = maxRecommendedSize && asset.size > maxRecommendedSize;\r\n        if (isLarge && path.extname(asset.name) === '.js') {\r\n            suggestBundleSplitting = true;\r\n        }\r\n        console.log(\r\n            '  ' +\r\n            (isLarge ? chalk.yellow(sizeLabel) : sizeLabel) +\r\n            '  ' +\r\n            chalk.dim(asset.folder + path.sep) +\r\n            chalk.cyan(asset.name)\r\n        );\r\n    });\r\n    if (suggestBundleSplitting) {\r\n        console.log();\r\n        console.log(\r\n            chalk.yellow('The bundle size is significantly larger than recommended.')\r\n        );\r\n        console.log(\r\n            chalk.yellow(\r\n                'Consider reducing it with code splitting: https://goo.gl/9VhYWB'\r\n            )\r\n        );\r\n        console.log(\r\n            chalk.yellow(\r\n                'You can also analyze the project dependencies: https://goo.gl/LeUzfb'\r\n            )\r\n        );\r\n    }\r\n}\r\n\r\nfunction removeFileNameHash(buildFolder, fileName) {\r\n    return fileName\r\n        .replace(buildFolder, '')\r\n        .replace(/\\\\/g, '/')\r\n        .replace(\r\n            /\\/?(.*)(\\.[0-9a-f]+)(\\.chunk)?(\\.js|\\.css)/,\r\n            (match, p1, p2, p3, p4) => p1 + p4\r\n        );\r\n}\r\n\r\n// Input: 1024, 2048\r\n// Output: \"(+1 KB)\"\r\nfunction getDifferenceLabel(currentSize, previousSize) {\r\n    var FIFTY_KILOBYTES = 1024 * 50;\r\n    var difference = currentSize - previousSize;\r\n    var fileSize = !Number.isNaN(difference) ? filesize(difference) : 0;\r\n    if (difference >= FIFTY_KILOBYTES) {\r\n        return chalk.red('+' + fileSize);\r\n    } else if (difference < FIFTY_KILOBYTES && difference > 0) {\r\n        return chalk.yellow('+' + fileSize);\r\n    } else if (difference < 0) {\r\n        return chalk.green(fileSize);\r\n    } else {\r\n        return '';\r\n    }\r\n}\r\n\r\nfunction measureFileSizesBeforeBuild(buildFolder) {\r\n    return new Promise(resolve => {\r\n        recursive(buildFolder, (err, fileNames) => {\r\n            var sizes;\r\n            if (!err && fileNames) {\r\n                sizes = fileNames.filter(canReadAsset).reduce((memo, fileName) => {\r\n                    var contents = fs.readFileSync(fileName);\r\n                    var key = removeFileNameHash(buildFolder, fileName);\r\n                    memo[key] = sync(contents);\r\n                    return memo;\r\n                }, {});\r\n            }\r\n            resolve({\r\n                root: buildFolder,\r\n                sizes: sizes || {},\r\n            });\r\n        });\r\n    });\r\n}\r\n\r\nexport const FileSizeReporter = {\r\n    measureFileSizesBeforeBuild: measureFileSizesBeforeBuild,\r\n    printFileSizesAfterBuild: printFileSizesAfterBuild,\r\n};"]}