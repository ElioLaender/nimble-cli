{"version":3,"file":"webpack.config.js","sourceRoot":"","sources":["../../../src/commands/config/webpack.config.ts"],"names":[],"mappings":"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","sourcesContent":["import path from 'path';\r\nimport webpack from 'webpack';\r\nimport CleanWebpackPlugin from 'clean-webpack-plugin';\r\nimport HtmlWebpackPlugin from 'html-webpack-plugin';\r\nimport CopyPlugin from 'copy-webpack-plugin';\r\nimport PrerenderSpaPlugin from 'prerender-spa-plugin';\r\nimport MiniCssExtractPlugin from 'mini-css-extract-plugin';\r\n\r\nlet configuration: any = {};\r\ntry { configuration = require(process.cwd() + '/nimble.json'); }\r\ncatch{ configuration = {}; }\r\n\r\nconst Renderer = PrerenderSpaPlugin.PuppeteerRenderer;\r\n\r\nconst distPath = path.resolve(process.cwd(), 'build');\r\n\r\nexport async function webpackConfig(env: string, isProdMod: boolean = false) {\r\n    let enviroment = await loadEnvFile(env);\r\n    let config = {\r\n        mode: isProdMod ? 'production' : 'development',\r\n        entry: getEntries(),\r\n        output: {\r\n            chunkFilename: '[name].bundle.[chunkhash].js',\r\n            filename: '[name].bundle.[chunkhash].js',\r\n            path: distPath,\r\n            publicPath: '/'\r\n        },\r\n        watch: !isProdMod,\r\n        watchOptions: { ignored: [`${process.cwd()}/node_modules`] },\r\n        plugins: getPlugins(isProdMod, enviroment),\r\n        module: {\r\n            rules: getRules(isProdMod, enviroment)\r\n        },\r\n        resolve: {\r\n            extensions: ['.ts', '.js', '.scss'],\r\n            alias: (() => {\r\n                const tsconfigPath = process.cwd() + '/tsconfig.json';\r\n                const { baseUrl, paths } = require(tsconfigPath).compilerOptions;\r\n                const pathPrefix = path.resolve(path.dirname(tsconfigPath), baseUrl);\r\n                const aliases = {} as any;\r\n\r\n                Object.keys(paths).forEach((item) => {\r\n                    const name = item.replace('/*', '');\r\n                    const value = path.resolve(pathPrefix, paths[item][0].replace('/*', ''));\r\n\r\n                    aliases[name] = value;\r\n                });\r\n\r\n                return aliases;\r\n            })(),\r\n        },\r\n        optimization: {\r\n            splitChunks: {\r\n                cacheGroups: {\r\n                    defaultVendors: {\r\n                        reuseExistingChunk: true\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    if (!isProdMod)\r\n        config['devtool'] = 'source-map';\r\n\r\n    return config;\r\n};\r\n\r\nfunction getEntries() {\r\n\r\n    let entry: { [key: string]: string[] } = {\r\n        'main': [process.cwd() + '/src/main.ts']\r\n    };\r\n\r\n    if (configuration.vendors) {\r\n        if (configuration.vendors.js && configuration.vendors.js.length > 0)\r\n            entry.main = entry.main.concat(configuration.vendors.js.map((file: string) => {\r\n                return process.cwd() + (file.endsWith('/') ? '' : '/') + file;\r\n            }));\r\n        if (configuration.vendors.css && configuration.vendors.css.length > 0)\r\n            entry.main = entry.main.concat(configuration.vendors.css.map((file: string) => {\r\n                return process.cwd() + (file.endsWith('/') ? '' : '/') + file;\r\n            }));\r\n    }\r\n\r\n    return entry;\r\n}\r\n\r\nfunction getPlugins(isProdMod: boolean, enviroment: any) {\r\n    let plugins = [\r\n        new CleanWebpackPlugin(),\r\n        new HtmlWebpackPlugin({\r\n            template: process.cwd() + '/public/index.html',\r\n            filename: 'index.html',\r\n            hash: true,\r\n            minify: isProdMod ? {\r\n                removeComments: true,\r\n                collapseWhitespace: true,\r\n                removeRedundantAttributes: true,\r\n                useShortDoctype: true,\r\n                removeEmptyAttributes: true,\r\n                removeStyleLinkTypeAttributes: true,\r\n                keepClosingSlash: true,\r\n                minifyJS: true,\r\n                minifyCSS: true,\r\n                minifyURLs: true,\r\n            } : undefined\r\n        }),\r\n        new CopyPlugin([\r\n            { from: 'public', to: '.' },\r\n        ]),\r\n        new MiniCssExtractPlugin({\r\n            filename: !isProdMod ? '[name].css' : '[name].bundle.[hash].css',\r\n            chunkFilename: !isProdMod ? '[id].css' : '[id].bundle.[hash].css'\r\n        }),\r\n        new webpack.DefinePlugin({\r\n            'process.env': JSON.stringify(enviroment)\r\n        })\r\n    ];\r\n\r\n    let preRender = configuration['pre-render'];\r\n    if (isProdMod && preRender && preRender.enabled && preRender.routes && preRender.routes.length > 0) {\r\n        let routes = (preRender.routes as string[]).map(x => !x.startsWith('/') ? `/${x}` : x);\r\n        plugins.push(new PrerenderSpaPlugin({\r\n            staticDir: distPath,\r\n            routes: routes,\r\n            renderer: new Renderer({\r\n                renderAfterDocumentEvent: 'render-event'\r\n            }),\r\n            postProcess: (renderedRoute: any) => {\r\n                renderedRoute.html = renderedRoute.html.replace('<nimble-root', '<nimble-root style=\"visibility: hidden;\"');\r\n                renderedRoute.html = renderedRoute.html.replace(/<style type=\"text\\/css\">(.|\\n)*?<\\/style>/g, '');\r\n                return renderedRoute;\r\n            }\r\n        }));\r\n    }\r\n\r\n    return plugins;\r\n}\r\n\r\nfunction getRules(isProdMod: boolean, enviroment: any) {\r\n    let rules = [\r\n        {\r\n            test: /\\.(ts|js)x?$/,\r\n            exclude: /node_modules/,\r\n            loader: 'ts-loader'\r\n        },\r\n        {\r\n            test: /\\.(sc|sa|c)ss$/,\r\n            exclude: /\\.module.(s(a|c)ss)$/,\r\n            loader: [\r\n                !isProdMod ? 'style-loader' : MiniCssExtractPlugin.loader,\r\n                'css-loader',\r\n                {\r\n                    loader: 'sass-loader',\r\n                    options: {\r\n                        sourceMap: !isProdMod,\r\n                        minimize: isProdMod\r\n                    }\r\n                }\r\n            ]\r\n        },\r\n        {\r\n            test: /\\.(svg|png|jpg)$/,\r\n            loader: 'file-loader',\r\n            options: {\r\n                name: '[name].[ext]',\r\n                outputhPath: 'assets/img/',\r\n                publicPath: 'assets/img/'\r\n            }\r\n        },\r\n        {\r\n            test: /\\.(ttf|woff|woff2)$/,\r\n            loader: 'file-loader',\r\n            options: {\r\n                name: '[name].[ext]',\r\n                outputhPath: 'assets/fonts/',\r\n                publicPath: 'assets/fonts/'\r\n            }\r\n        },\r\n        {\r\n            test: /\\.html$/,\r\n            loader: 'html-loader',\r\n            options: {\r\n                minimize: isProdMod\r\n            },\r\n        }\r\n    ];\r\n\r\n    return rules;\r\n}\r\n\r\nasync function loadEnvFile(env: string) {\r\n    if (env) {\r\n        var enviroment = await import(`${process.cwd()}/src/environments/env.${env}.js`);\r\n        if (enviroment) {\r\n            return enviroment;\r\n        }\r\n    }\r\n    return {\r\n        production: true\r\n    };\r\n}"]}