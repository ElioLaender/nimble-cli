{"version":3,"file":"webpack.config.js","sourceRoot":"","sources":["../../../src/commands/config/webpack.config.ts"],"names":[],"mappings":"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","sourcesContent":["import path from 'path';\r\nimport webpack from 'webpack';\r\nimport CleanWebpackPlugin from 'clean-webpack-plugin';\r\nimport HtmlWebpackPlugin from 'html-webpack-plugin';\r\nimport CopyPlugin from 'copy-webpack-plugin';\r\nimport PrerenderSpaPlugin from 'prerender-spa-plugin';\r\n\r\nlet configuration: any = {};\r\ntry { configuration = require(process.cwd() + '/src/configuration.json'); }\r\ncatch{ configuration = {}; }\r\n\r\nconst Renderer = PrerenderSpaPlugin.PuppeteerRenderer;\r\n\r\nconst distPath = path.resolve(process.cwd(), 'build');\r\n\r\nexport function webpackConfig(env: string, isProdMod: boolean = false) {\r\n    let enviroment = loadEnvFile(env);\r\n    let config = {\r\n        mode: isProdMod ? 'production' : 'development',\r\n        entry: getEntries(),\r\n        output: {\r\n            chunkFilename: '[name].[chunkhash].bundle.js',\r\n            filename: '[name].[chunkhash].bundle.js',\r\n            path: distPath,\r\n            publicPath: '/'\r\n        },\r\n        watch: !isProdMod,\r\n        watchOptions: { ignored: [`${process.cwd()}/node_modules`] },\r\n        plugins: getPlugins(isProdMod, enviroment),\r\n        module: {\r\n            rules: getRules(isProdMod, enviroment)\r\n        },\r\n        resolve: {\r\n            extensions: [\".tsx\", \".ts\", \".js\"],\r\n            alias: (function () {\r\n                const tsconfigPath = process.cwd() + '/tsconfig.json';\r\n                const { baseUrl, paths } = require(tsconfigPath).compilerOptions;\r\n                const pathPrefix = path.resolve(path.dirname(tsconfigPath), baseUrl);\r\n                const aliases = {} as any;\r\n\r\n                Object.keys(paths).forEach((item) => {\r\n                    const name = item.replace(\"/*\", \"\");\r\n                    const value = path.resolve(pathPrefix, paths[item][0].replace(\"/*\", \"\"));\r\n\r\n                    aliases[name] = value;\r\n                });\r\n\r\n                return aliases;\r\n            })(),\r\n        }\r\n    };\r\n\r\n    if (!isProdMod)\r\n        config['devtool'] = 'source-map';\r\n\r\n    return config;\r\n};\r\n\r\nfunction getEntries() {\r\n\r\n    let entry = { 'main': process.cwd() + '/src/index.ts' } as any;\r\n\r\n    if (configuration.vendors) {\r\n        if (configuration.vendors.js && configuration.vendors.js.length > 0)\r\n            entry['js.vendors'] = configuration.vendors.js.map((file: string) => {\r\n                return process.cwd() + (file.endsWith('/') ? '' : '/') + file;\r\n            });\r\n        if (configuration.vendors.css && configuration.vendors.css.length > 0)\r\n            entry['css.vendors'] = configuration.vendors.css.map((file: string) => {\r\n                return process.cwd() + (file.endsWith('/') ? '' : '/') + file;\r\n            });\r\n    }\r\n    return entry;\r\n}\r\n\r\nfunction getPlugins(isProdMod: boolean, enviroment: any) {\r\n    let plugins = [\r\n        new CleanWebpackPlugin(),\r\n        new HtmlWebpackPlugin({\r\n            template: process.cwd() + '/public/index.html',\r\n            filename: 'index.html',\r\n            hash: true,\r\n            minify: isProdMod\r\n        }),\r\n        new CopyPlugin([\r\n            { from: 'public', to: '.' },\r\n        ]),\r\n        new webpack.DefinePlugin({\r\n            'process.env': JSON.stringify(enviroment)\r\n        })\r\n    ];\r\n\r\n    let preRender = configuration['pre-render'];\r\n    if (isProdMod && preRender && preRender.enabled && preRender.routes && preRender.routes.length > 0) {\r\n        plugins.push(new PrerenderSpaPlugin({\r\n            staticDir: distPath,\r\n            routes: preRender.routes,\r\n            renderer: new Renderer({\r\n                renderAfterDocumentEvent: 'render-event'\r\n            }),\r\n            postProcess: function (renderedRoute: any) {\r\n                renderedRoute.html = renderedRoute.html.replace('<nimble-root', '<nimble-root style=\"visibility: hidden;\"');\r\n                renderedRoute.html = renderedRoute.html.replace(/<style type=\"text\\/css\">(.|\\n)*?<\\/style>/g, '');\r\n                return renderedRoute;\r\n            }\r\n        }));\r\n    }\r\n\r\n    return plugins;\r\n}\r\n\r\nfunction getRules(isProdMod: boolean, enviroment: any) {\r\n    let rules = [\r\n        {\r\n            test: /\\.(ts|js)x?$/,\r\n            exclude: /node_modules/,\r\n            loader: 'ts-loader'\r\n        },\r\n        {\r\n            test: /\\.css$/,\r\n            use: ['style-loader', 'css-loader']\r\n        },\r\n        {\r\n            test: /\\.scss$/,\r\n            use: [\r\n                'style-loader',\r\n                'css-loader',\r\n                'sass-loader',\r\n            ]\r\n        },\r\n        {\r\n            test: /\\.(svg|png|jpg)$/,\r\n            loader: 'file-loader',\r\n            options: {\r\n                name: '[name].[ext]',\r\n                outputhPath: 'assets/img/',\r\n                publicPath: 'assets/img/'\r\n            }\r\n        },\r\n        {\r\n            test: /\\.(ttf|woff|woff2)$/,\r\n            loader: 'file-loader',\r\n            options: {\r\n                name: '[name].[ext]',\r\n                outputhPath: 'assets/fonts/',\r\n                publicPath: 'assets/fonts/'\r\n            }\r\n        },\r\n        {\r\n            test: /\\.html$/,\r\n            use: 'html-loader'\r\n        }\r\n    ];\r\n\r\n    return rules;\r\n}\r\n\r\nfunction loadEnvFile(env: string) {\r\n    if (env) {\r\n        var enviroment = require(`${process.cwd()}/src/enviroments/env.${env}.js`);\r\n        if (enviroment) {\r\n            return enviroment;\r\n        }\r\n    }\r\n    return {\r\n        production: true\r\n    };\r\n}"]}